name: Codex Full Repo Review

on:
  pull_request:
    branches:
      - main

jobs:
  codex_review:
    name: Run Codex Review On PR
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install OpenAI SDK
        run: pip install "openai>=1.0.0"

      - name: Run Codex review
        run: |
          python <<'PY'
          import os
          from pathlib import Path
          from openai import OpenAI

          client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])
          model = os.environ.get("OPENAI_MODEL") or "gpt-4o-mini"

          repo_root = Path(".").resolve()
          ignore_dirs = {".git", ".venv", "venv", "__pycache__"}
          max_file_chars = 20000
          max_total_chars = 400000
          total_chars = 0
          files_payload = []

          def should_skip(path: Path) -> bool:
              return any(part in ignore_dirs for part in path.parts)

          for path in repo_root.rglob("*"):
              if not path.is_file():
                  continue
              if should_skip(path):
                  continue
              try:
                  text = path.read_text(encoding="utf-8", errors="ignore")
              except Exception as exc:
                  text = f"<<Unable to read file: {exc}>>"

              if len(text) > max_file_chars:
                  text = text[:max_file_chars] + "\n<<truncated>>"

              rel_path = path.relative_to(repo_root).as_posix()
              files_payload.append(f"File: {rel_path}\n{text}")
              total_chars += len(text)
              if total_chars >= max_total_chars:
                  break

          header = (
              "Review the following repository contents. "
              "Identify defects, security issues, test gaps, and risky design choices. "
              "Organize findings per file using Markdown bullets, include code references, "
              "and end with a short repo-level summary."
          )

          messages = [
              {
                  "role": "system",
                  "content": "You are Codex, an expert software reviewer who produces concise, actionable reports.",
              },
              {"role": "user", "content": header},
          ]

          for chunk in files_payload:
              messages.append({"role": "user", "content": chunk})

          response = client.chat.completions.create(
              model=model,
              messages=messages,
              temperature=0.2,
          )

          report = response.choices[0].message.content.strip()
          Path("codex-review.md").write_text(report, encoding="utf-8")
          print(report)
          PY

      - name: Upload Codex report
        uses: actions/upload-artifact@v4
        with:
          name: codex-review
          path: codex-review.md
